# Python SCALE Codec Library
#
# Copyright 2018-2019 openAware BV (NL).
# This file is part of Polkascan.
#
# Polkascan is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Polkascan is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Polkascan. If not, see <http://www.gnu.org/licenses/>.

import datetime
import unittest
from _blake2 import blake2b

from scalecodec import CompactU32, U16
from scalecodec.base import ScaleDecoder, ScaleBytes, RemainingScaleBytesNotEmptyException, \
    InvalidScaleTypeValueException
from scalecodec.block import ExtrinsicsDecoder, MetadataDecoder, EventsDecoder, LogDigest


class TestScaleTypes(unittest.TestCase):

    def test_compact_u32(self):
        obj = ScaleDecoder.get_decoder_class('Compact<u32>', ScaleBytes("0x02093d00"))
        obj.decode()
        self.assertEqual(obj.value, 1000000)

    def test_compact_u32_1byte(self):
        obj = ScaleDecoder.get_decoder_class('Compact<u32>', ScaleBytes("0x18"))
        obj.decode()
        self.assertEqual(obj.value, 6)

    def test_compact_u32_remaining_bytes(self):
        obj = ScaleDecoder.get_decoder_class('Compact<u32>', ScaleBytes("0x02093d0001"))
        self.assertRaises(RemainingScaleBytesNotEmptyException, obj.decode)

    def test_compact_bool_true(self):
        obj = ScaleDecoder.get_decoder_class('bool', ScaleBytes("0x01"))
        obj.decode()
        self.assertEqual(obj.value, True)

    def test_compact_bool_false(self):
        obj = ScaleDecoder.get_decoder_class('bool', ScaleBytes("0x00"))
        obj.decode()
        self.assertEqual(obj.value, False)

    def test_compact_bool_invalid(self):
        obj = ScaleDecoder.get_decoder_class('bool', ScaleBytes("0x02"))
        self.assertRaises(InvalidScaleTypeValueException, obj.decode)

    def test_vec_accountid(self):
        obj = ScaleDecoder.get_decoder_class(
            'Vec<AccountId>',
            ScaleBytes(
                "0x0865d2273adeb04478658e183dc5edf41f1d86e42255442af62e72dbf1e6c0b97765d2273adeb04478658e183dc5edf41f1d86e42255442af62e72dbf1e6c0b977")
        )
        obj.decode()
        self.assertListEqual(obj.value, [
            '0x65d2273adeb04478658e183dc5edf41f1d86e42255442af62e72dbf1e6c0b977',
            '0x65d2273adeb04478658e183dc5edf41f1d86e42255442af62e72dbf1e6c0b977'
        ])

    def test_validatorprefs_struct(self):
        obj = ScaleDecoder.get_decoder_class('ValidatorPrefs', ScaleBytes("0x0c00"))
        obj.decode()
        self.assertEqual(obj.value, {"col1": 3, "col2": 0})

    def test_implied_struct(self):
        obj = ScaleDecoder.get_decoder_class('(Compact<u32>,Compact<u32>)', ScaleBytes("0x0c00"))
        obj.decode()
        self.assertEqual(obj.value, {"col1": 3, "col2": 0})

    def test_address(self):
        obj = ScaleDecoder.get_decoder_class(
            'Address',
            ScaleBytes("0xff1fa9d1bd1db014b65872ee20aee4fd4d3a942d95d3357f463ea6c799130b6318")
        )
        obj.decode()
        self.assertEqual(obj.value, '1fa9d1bd1db014b65872ee20aee4fd4d3a942d95d3357f463ea6c799130b6318')

    def test_moment(self):
        obj = ScaleDecoder.get_decoder_class('Compact<Moment>', ScaleBytes("0x03d68b655c"))
        obj.decode()
        print(obj)
        self.assertEqual(obj.value, datetime.datetime(2019, 2, 14, 15, 40, 6))

    def test_extrinsics(self):
        metadata_vx = "0x6d65746104241873797374656d1853797374656d012c304163636f756e744e6f6e636501010130543a3a4163636f756e74496420543a3a496e64657800200000000000000000047c2045787472696e73696373206e6f6e636520666f72206163636f756e74732e3845787472696e736963436f756e7400000c753332040004b820546f74616c2065787472696e7369637320636f756e7420666f72207468652063757272656e7420626c6f636b2e40416c6c45787472696e736963734c656e00000c753332040004390120546f74616c206c656e67746820696e20627974657320666f7220616c6c2065787472696e736963732070757420746f6765746865722c20666f72207468652063757272656e7420626c6f636b2e24426c6f636b4861736801010138543a3a426c6f636b4e756d6265721c543a3a48617368008000000000000000000000000000000000000000000000000000000000000000000498204d6170206f6620626c6f636b206e756d6265727320746f20626c6f636b206861736865732e3445787472696e736963446174610101010c7533321c5665633c75383e0004000431012045787472696e73696373206461746120666f72207468652063757272656e7420626c6f636b20286d6170732065787472696e736963277320696e64657820746f206974732064617461292e2852616e646f6d5365656401001c543a3a4861736880000000000000000000000000000000000000000000000000000000000000000004882052616e646f6d2073656564206f66207468652063757272656e7420626c6f636b2e184e756d626572010038543a3a426c6f636b4e756d626572200000000000000000040901205468652063757272656e7420626c6f636b206e756d626572206265696e672070726f6365737365642e205365742062792060657865637574655f626c6f636b602e28506172656e744861736801001c543a3a4861736880000000000000000000000000000000000000000000000000000000000000000004702048617368206f66207468652070726576696f757320626c6f636b2e3845787472696e73696373526f6f7401001c543a3a486173688000000000000000000000000000000000000000000000000000000000000000000415012045787472696e7369637320726f6f74206f66207468652063757272656e7420626c6f636b2c20616c736f2070617274206f662074686520626c6f636b206865616465722e18446967657374010024543a3a446967657374040004f020446967657374206f66207468652063757272656e7420626c6f636b2c20616c736f2070617274206f662074686520626c6f636b206865616465722e184576656e74730100685665633c4576656e745265636f72643c543a3a4576656e743e3e040004a0204576656e7473206465706f736974656420666f72207468652063757272656e7420626c6f636b2e0001084045787472696e7369635375636365737300049420416e2065787472696e73696320636f6d706c65746564207375636365737366756c6c792e3c45787472696e7369634661696c656400045420416e2065787472696e736963206661696c65642e2474696d657374616d702454696d657374616d7001100c4e6f77010024543a3a4d6f6d656e7420000000000000000004902043757272656e742074696d6520666f72207468652063757272656e7420626c6f636b2e2c426c6f636b506572696f64000024543a3a4d6f6d656e740400044501204f6c642073746f72616765206974656d2070726f766964656420666f7220636f6d7061746962696c6974792e2052656d6f766520616674657220616c6c206e6574776f726b732075706772616465642e344d696e696d756d506572696f64010024543a3a4d6f6d656e7420030000000000000010690120546865206d696e696d756d20706572696f64206265747765656e20626c6f636b732e204265776172652074686174207468697320697320646966666572656e7420746f20746865202a65787065637465642a20706572696f64690120746861742074686520626c6f636b2070726f64756374696f6e206170706172617475732070726f76696465732e20596f75722063686f73656e20636f6e73656e7375732073797374656d2077696c6c2067656e6572616c6c79650120776f726b2077697468207468697320746f2064657465726d696e6520612073656e7369626c6520626c6f636b2074696d652e20652e672e20466f7220417572612c2069742077696c6c20626520646f75626c6520746869737020706572696f64206f6e2064656661756c742073657474696e67732e24446964557064617465010010626f6f6c040004b420446964207468652074696d657374616d7020676574207570646174656420696e207468697320626c6f636b3f01040c736574040c6e6f7748436f6d706163743c543a3a4d6f6d656e743e205820536574207468652063757272656e742074696d652e00750120546869732063616c6c2073686f756c6420626520696e766f6b65642065786163746c79206f6e63652070657220626c6f636b2e2049742077696c6c2070616e6963206174207468652066696e616c697a6174696f6e2070686173652cbc20696620746869732063616c6c206861736e2774206265656e20696e766f6b656420627920746861742074696d652e008d01205468652074696d657374616d702073686f756c642062652067726561746572207468616e207468652070726576696f7573206f6e652062792074686520616d6f756e742073706563696669656420627920606d696e696d756d5f706572696f64602e00d820546865206469737061746368206f726967696e20666f7220746869732063616c6c206d7573742062652060496e686572656e74602e0024636f6e73656e73757324436f6e73656e73757301044c4f726967696e616c417574686f7269746965730000485665633c543a3a53657373696f6e4b65793e040000011c487265706f72745f6d69736265686176696f72041c5f7265706f72741c5665633c75383e0464205265706f727420736f6d65206d69736265686176696f722e306e6f74655f6f66666c696e65041c6f66666c696e65f43c543a3a496e686572656e744f66666c696e655265706f727420617320496e686572656e744f66666c696e655265706f72743e3a3a496e686572656e74045101204e6f74652074686174207468652070726576696f757320626c6f636b27732076616c696461746f72206d697373656420697473206f70706f7274756e69747920746f2070726f706f7365206120626c6f636b2e1872656d61726b041c5f72656d61726b1c5665633c75383e046c204d616b6520736f6d65206f6e2d636861696e2072656d61726b2e387365745f686561705f7061676573041470616765730c75363404fc2053657420746865206e756d626572206f6620706167657320696e2074686520576562417373656d626c7920656e7669726f6e6d656e74277320686561702e207365745f636f6465040c6e65771c5665633c75383e04482053657420746865206e657720636f64652e2c7365745f73746f7261676504146974656d73345665633c4b657956616c75653e046c2053657420736f6d65206974656d73206f662073746f726167652e306b696c6c5f73746f7261676504106b657973205665633c4b65793e0478204b696c6c20736f6d65206974656d732066726f6d2073746f726167652e000c706f770c506f7701204047656e65736973506f77546172676574010030543a3a506f77546172676574800000000000000000000000000000000000000000000000000000000000000000044c2047656e6573697320504f572074617267657430506f7754617267657441646a010038543a3a426c6f636b4e756d62657220000000000000000004a420504f57207461726765742061646a75737420706572696f6420696e20626c6f636b206e756d6265723c546172676574426c6f636b54696d6501000c75363420000000000000000004742054617267657420626c6f636b2074696d6520696e207365636f6e64732c426c6f636b52657761726401003042616c616e63654f663c543e4000000000000000000000000000000000043420426c6f636b2072657761726448426c6f636b5265776172644c6174656e6379010038543a3a426c6f636b4e756d626572200000000000000000045420426c6f636b20726577617264206c6174656e63792c526577617264506c616e730100ec5665633c526577617264506c616e3c543a3a426c6f636b4e756d6265722c20543a3a4163636f756e7449642c2042616c616e63654f663c543e3e3e040004982053746f7261676520666f7220506f77496e666f20666f722063757272656e7420626c6f636b20546f74616c46656501003042616c616e63654f663c543e400000000000000000000000000000000004a02053746f7261676520666f7220746f74616c2066656520666f722063757272656e7420626c6f636b3843757272656e74506f77496e666f000054506f77496e666f3c543a3a4163636f756e7449643e040004a02053746f7261676520666f7220746f74616c2066656520666f722063757272656e7420626c6f636b0104307365745f706f775f696e666f0410696e666f54506f77496e666f3c543a3a4163636f756e7449643e000104185265776172640484526577617264506c616e3c4e2c204163636f756e7449642c2042616c616e63653e001c696e64696365731c496e646963657301082c4e657874456e756d53657401003c543a3a4163636f756e74496e6465781000000000047c20546865206e657874206672656520656e756d65726174696f6e207365742e1c456e756d5365740101013c543a3a4163636f756e74496e646578445665633c543a3a4163636f756e7449643e00040004582054686520656e756d65726174696f6e20736574732e010001043c4e65774163636f756e74496e64657808244163636f756e744964304163636f756e74496e64657810882041206e6577206163636f756e7420696e646578207761732061737369676e65642e0005012054686973206576656e74206973206e6f7420747269676765726564207768656e20616e206578697374696e6720696e64657820697320726561737369676e65646020746f20616e6f7468657220604163636f756e744964602e2062616c616e6365732042616c616e636573012834546f74616c49737375616e6365010028543a3a42616c616e6365400000000000000000000000000000000004982054686520746f74616c20756e6974732069737375656420696e207468652073797374656d2e484578697374656e7469616c4465706f736974010028543a3a42616c616e6365400000000000000000000000000000000004d420546865206d696e696d756d20616d6f756e7420726571756972656420746f206b65657020616e206163636f756e74206f70656e2e2c5472616e73666572466565010028543a3a42616c616e636540000000000000000000000000000000000494205468652066656520726571756972656420746f206d616b652061207472616e736665722e2c4372656174696f6e466565010028543a3a42616c616e63654000000000000000000000000000000000049c205468652066656520726571756972656420746f2063726561746520616e206163636f756e742e485472616e73616374696f6e42617365466565010028543a3a42616c616e6365400000000000000000000000000000000004dc205468652066656520746f206265207061696420666f72206d616b696e672061207472616e73616374696f6e3b2074686520626173652e485472616e73616374696f6e42797465466565010028543a3a42616c616e63654000000000000000000000000000000000040d01205468652066656520746f206265207061696420666f72206d616b696e672061207472616e73616374696f6e3b20746865207065722d6279746520706f7274696f6e2e1c56657374696e6700010130543a3a4163636f756e7449646c56657374696e675363686564756c653c543a3a42616c616e63653e00040004d820496e666f726d6174696f6e20726567617264696e67207468652076657374696e67206f66206120676976656e206163636f756e742e2c4672656542616c616e636501010130543a3a4163636f756e74496428543a3a42616c616e63650040000000000000000000000000000000002c9c20546865202766726565272062616c616e6365206f66206120676976656e206163636f756e742e004101205468697320697320746865206f6e6c792062616c616e63652074686174206d61747465727320696e207465726d73206f66206d6f7374206f7065726174696f6e73206f6e20746f6b656e732e204974750120616c6f6e65206973207573656420746f2064657465726d696e65207468652062616c616e6365207768656e20696e2074686520636f6e747261637420657865637574696f6e20656e7669726f6e6d656e742e205768656e207468697355012062616c616e63652066616c6c732062656c6f77207468652076616c7565206f6620604578697374656e7469616c4465706f736974602c207468656e20746865202763757272656e74206163636f756e74272069733d012064656c657465643a207370656369666963616c6c7920604672656542616c616e6365602e20467572746865722c2074686520604f6e4672656542616c616e63655a65726f602063616c6c6261636b450120697320696e766f6b65642c20676976696e672061206368616e636520746f2065787465726e616c206d6f64756c657320746f20636c65616e2075702064617461206173736f636961746564207769746854207468652064656c65746564206163636f756e742e005d01206073797374656d3a3a4163636f756e744e6f6e63656020697320616c736f2064656c657465642069662060526573657276656442616c616e63656020697320616c736f207a65726f2028697420616c736f2067657473150120636f6c6c617073656420746f207a65726f2069662069742065766572206265636f6d6573206c657373207468616e20604578697374656e7469616c4465706f736974602e3c526573657276656442616c616e636501010130543a3a4163636f756e74496428543a3a42616c616e63650040000000000000000000000000000000002c75012054686520616d6f756e74206f66207468652062616c616e6365206f66206120676976656e206163636f756e7420746861742069732065787465726e616c6c792072657365727665643b20746869732063616e207374696c6c206765749c20736c61736865642c20627574206765747320736c6173686564206c617374206f6620616c6c2e006d0120546869732062616c616e63652069732061202772657365727665272062616c616e63652074686174206f746865722073756273797374656d732075736520696e206f7264657220746f2073657420617369646520746f6b656e732501207468617420617265207374696c6c20276f776e65642720627920746865206163636f756e7420686f6c6465722c20627574207768696368206172652073757370656e6461626c652e007501205768656e20746869732062616c616e63652066616c6c732062656c6f77207468652076616c7565206f6620604578697374656e7469616c4465706f736974602c207468656e2074686973202772657365727665206163636f756e7427b42069732064656c657465643a207370656369666963616c6c792c2060526573657276656442616c616e6365602e004d01206073797374656d3a3a4163636f756e744e6f6e63656020697320616c736f2064656c6574656420696620604672656542616c616e63656020697320616c736f207a65726f2028697420616c736f2067657473190120636f6c6c617073656420746f207a65726f2069662069742065766572206265636f6d6573206c657373207468616e20604578697374656e7469616c4465706f736974602e29144c6f636b7301010130543a3a4163636f756e744964b05665633c42616c616e63654c6f636b3c543a3a42616c616e63652c20543a3a426c6f636b4e756d6265723e3e00040004b820416e79206c6971756964697479206c6f636b73206f6e20736f6d65206163636f756e742062616c616e6365732e010c207472616e736665720810646573748c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f757263651476616c75654c436f6d706163743c543a3a42616c616e63653e20d8205472616e7366657220736f6d65206c697175696420667265652062616c616e636520746f20616e6f74686572206163636f756e742e00090120607472616e73666572602077696c6c207365742074686520604672656542616c616e636560206f66207468652073656e64657220616e642072656365697665722e21012049742077696c6c2064656372656173652074686520746f74616c2069737375616e6365206f66207468652073797374656d2062792074686520605472616e73666572466565602e1501204966207468652073656e6465722773206163636f756e742069732062656c6f7720746865206578697374656e7469616c206465706f736974206173206120726573756c74b4206f6620746865207472616e736665722c20746865206163636f756e742077696c6c206265207265617065642e00190120546865206469737061746368206f726967696e20666f7220746869732063616c6c206d75737420626520605369676e65646020627920746865207472616e736163746f722e2c7365745f62616c616e63650c0c77686f8c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f7572636510667265654c436f6d706163743c543a3a42616c616e63653e2072657365727665644c436f6d706163743c543a3a42616c616e63653e209420536574207468652062616c616e636573206f66206120676976656e206163636f756e742e00010120546869732077696c6c20616c74657220604672656542616c616e63656020616e642060526573657276656442616c616e63656020696e2073746f726167652e190120496620746865206e65772066726565206f722072657365727665642062616c616e63652069732062656c6f7720746865206578697374656e7469616c206465706f7369742c25012069742077696c6c20616c736f2064656372656173652074686520746f74616c2069737375616e6365206f66207468652073797374656d202860546f74616c49737375616e63656029d820616e6420726573657420746865206163636f756e74206e6f6e636520286073797374656d3a3a4163636f756e744e6f6e636560292e00b420546865206469737061746368206f726967696e20666f7220746869732063616c6c2069732060726f6f74602e3872656c61795f7472616e7366657210207472616e736665721c5665633c75383e1868656967687430436f6d706163743c7536343e10686173681c543a3a4861736818706172656e741c543a3a486173680c7020657865637574652072656c6179207472616e7366657220706172740000010c284e65774163636f756e7408244163636f756e7449641c42616c616e6365046c2041206e6577206163636f756e742077617320637265617465642e345265617065644163636f756e7404244163636f756e744964045c20416e206163636f756e7420776173207265617065642e205472616e7366657210244163636f756e744964244163636f756e7449641c42616c616e63651c42616c616e636504b0205472616e7366657220737563636565646564202866726f6d2c20746f2c2076616c75652c2066656573292e207368617264696e67205368617264696e6701105047656e657369735368617264696e67436f756e7401002c543a3a53686172644e756d08000004ac20546f74616c207368617264696e6720636f756e74207573656420696e2067656e6573697320626c6f636b545363616c654f75744f627365727665426c6f636b73010038543a3a426c6f636b4e756d62657220000000000000000004ac20546f74616c207368617264696e6720636f756e74207573656420696e2067656e6573697320626c6f636b4043757272656e745368617264496e666f0000585368617264496e666f3c543a3a53686172644e756d3e040004b42053746f7261676520666f72205368617264496e666f207573656420666f722063757272656e7420626c6f636b5043757272656e745363616c654f757450686173650000a85363616c654f757450686173653c543a3a426c6f636b4e756d6265722c20543a3a53686172644e756d3e040004c42053746f7261676520666f72205363616c654f75745068617365207573656420666f722063757272656e7420626c6f636b0104387365745f73686172645f696e666f0410696e666f585368617264496e666f3c543a3a53686172644e756d3e00001063726667304372666746696e616c69747901043450656e64696e674368616e67650000c853746f72656450656e64696e674368616e67653c543a3a426c6f636b4e756d6265722c20543a3a53657373696f6e4b65793e0400000104487570646174655f617574686f7269746965730410696e666f603c542061732054726169743e3a3a53657373696f6e4b6579000104384e6577417574686f72697469657304585665633c2853657373696f6e4b65792c20753634293e0490204e657720617574686f726974792073657420686173206265656e206170706c6965642e4066696e616c6974795f747261636b6572000001044c77726974655f66696e616c697a65645f6c6f67041068696e742c543a3a46696e616c4e756d08f42048696e7420746861742074686520617574686f72206f66207468697320626c6f636b207468696e6b732074686520626573742066696e616c697a65646c20626c6f636b2069732074686520676976656e206e756d6265722e00"
        metadata_decoder = MetadataDecoder(ScaleBytes(metadata_vx))

        metadata_decoder.decode()
        print(metadata_decoder)

        extrinsics_decoder = ExtrinsicsDecoder(
            data=ScaleBytes("0x01020054d41971dda5f960ccd25d4a0a27bff6e97535ab31bf2e3c99088cb22b2a4f5b00"),
            metadata=metadata_decoder
        )

        dataex = extrinsics_decoder.decode()
        print("------------------------------")

        print(dataex)

    def test_event(self):
        metadata_vx = "0x6d65746104241873797374656d1853797374656d012c304163636f756e744e6f6e636501010130543a3a4163636f756e74496420543a3a496e64657800200000000000000000047c2045787472696e73696373206e6f6e636520666f72206163636f756e74732e3845787472696e736963436f756e7400000c753332040004b820546f74616c2065787472696e7369637320636f756e7420666f72207468652063757272656e7420626c6f636b2e40416c6c45787472696e736963734c656e00000c753332040004390120546f74616c206c656e67746820696e20627974657320666f7220616c6c2065787472696e736963732070757420746f6765746865722c20666f72207468652063757272656e7420626c6f636b2e24426c6f636b4861736801010138543a3a426c6f636b4e756d6265721c543a3a48617368008000000000000000000000000000000000000000000000000000000000000000000498204d6170206f6620626c6f636b206e756d6265727320746f20626c6f636b206861736865732e3445787472696e736963446174610101010c7533321c5665633c75383e0004000431012045787472696e73696373206461746120666f72207468652063757272656e7420626c6f636b20286d6170732065787472696e736963277320696e64657820746f206974732064617461292e2852616e646f6d5365656401001c543a3a4861736880000000000000000000000000000000000000000000000000000000000000000004882052616e646f6d2073656564206f66207468652063757272656e7420626c6f636b2e184e756d626572010038543a3a426c6f636b4e756d626572200000000000000000040901205468652063757272656e7420626c6f636b206e756d626572206265696e672070726f6365737365642e205365742062792060657865637574655f626c6f636b602e28506172656e744861736801001c543a3a4861736880000000000000000000000000000000000000000000000000000000000000000004702048617368206f66207468652070726576696f757320626c6f636b2e3845787472696e73696373526f6f7401001c543a3a486173688000000000000000000000000000000000000000000000000000000000000000000415012045787472696e7369637320726f6f74206f66207468652063757272656e7420626c6f636b2c20616c736f2070617274206f662074686520626c6f636b206865616465722e18446967657374010024543a3a446967657374040004f020446967657374206f66207468652063757272656e7420626c6f636b2c20616c736f2070617274206f662074686520626c6f636b206865616465722e184576656e74730100685665633c4576656e745265636f72643c543a3a4576656e743e3e040004a0204576656e7473206465706f736974656420666f72207468652063757272656e7420626c6f636b2e0001084045787472696e7369635375636365737300049420416e2065787472696e73696320636f6d706c65746564207375636365737366756c6c792e3c45787472696e7369634661696c656400045420416e2065787472696e736963206661696c65642e2474696d657374616d702454696d657374616d7001100c4e6f77010024543a3a4d6f6d656e7420000000000000000004902043757272656e742074696d6520666f72207468652063757272656e7420626c6f636b2e2c426c6f636b506572696f64000024543a3a4d6f6d656e740400044501204f6c642073746f72616765206974656d2070726f766964656420666f7220636f6d7061746962696c6974792e2052656d6f766520616674657220616c6c206e6574776f726b732075706772616465642e344d696e696d756d506572696f64010024543a3a4d6f6d656e7420030000000000000010690120546865206d696e696d756d20706572696f64206265747765656e20626c6f636b732e204265776172652074686174207468697320697320646966666572656e7420746f20746865202a65787065637465642a20706572696f64690120746861742074686520626c6f636b2070726f64756374696f6e206170706172617475732070726f76696465732e20596f75722063686f73656e20636f6e73656e7375732073797374656d2077696c6c2067656e6572616c6c79650120776f726b2077697468207468697320746f2064657465726d696e6520612073656e7369626c6520626c6f636b2074696d652e20652e672e20466f7220417572612c2069742077696c6c20626520646f75626c6520746869737020706572696f64206f6e2064656661756c742073657474696e67732e24446964557064617465010010626f6f6c040004b420446964207468652074696d657374616d7020676574207570646174656420696e207468697320626c6f636b3f01040c736574040c6e6f7748436f6d706163743c543a3a4d6f6d656e743e205820536574207468652063757272656e742074696d652e00750120546869732063616c6c2073686f756c6420626520696e766f6b65642065786163746c79206f6e63652070657220626c6f636b2e2049742077696c6c2070616e6963206174207468652066696e616c697a6174696f6e2070686173652cbc20696620746869732063616c6c206861736e2774206265656e20696e766f6b656420627920746861742074696d652e008d01205468652074696d657374616d702073686f756c642062652067726561746572207468616e207468652070726576696f7573206f6e652062792074686520616d6f756e742073706563696669656420627920606d696e696d756d5f706572696f64602e00d820546865206469737061746368206f726967696e20666f7220746869732063616c6c206d7573742062652060496e686572656e74602e0024636f6e73656e73757324436f6e73656e73757301044c4f726967696e616c417574686f7269746965730000485665633c543a3a53657373696f6e4b65793e040000011c487265706f72745f6d69736265686176696f72041c5f7265706f72741c5665633c75383e0464205265706f727420736f6d65206d69736265686176696f722e306e6f74655f6f66666c696e65041c6f66666c696e65f43c543a3a496e686572656e744f66666c696e655265706f727420617320496e686572656e744f66666c696e655265706f72743e3a3a496e686572656e74045101204e6f74652074686174207468652070726576696f757320626c6f636b27732076616c696461746f72206d697373656420697473206f70706f7274756e69747920746f2070726f706f7365206120626c6f636b2e1872656d61726b041c5f72656d61726b1c5665633c75383e046c204d616b6520736f6d65206f6e2d636861696e2072656d61726b2e387365745f686561705f7061676573041470616765730c75363404fc2053657420746865206e756d626572206f6620706167657320696e2074686520576562417373656d626c7920656e7669726f6e6d656e74277320686561702e207365745f636f6465040c6e65771c5665633c75383e04482053657420746865206e657720636f64652e2c7365745f73746f7261676504146974656d73345665633c4b657956616c75653e046c2053657420736f6d65206974656d73206f662073746f726167652e306b696c6c5f73746f7261676504106b657973205665633c4b65793e0478204b696c6c20736f6d65206974656d732066726f6d2073746f726167652e000c706f770c506f7701204047656e65736973506f77546172676574010030543a3a506f77546172676574800000000000000000000000000000000000000000000000000000000000000000044c2047656e6573697320504f572074617267657430506f7754617267657441646a010038543a3a426c6f636b4e756d62657220000000000000000004a420504f57207461726765742061646a75737420706572696f6420696e20626c6f636b206e756d6265723c546172676574426c6f636b54696d6501000c75363420000000000000000004742054617267657420626c6f636b2074696d6520696e207365636f6e64732c426c6f636b52657761726401003042616c616e63654f663c543e4000000000000000000000000000000000043420426c6f636b2072657761726448426c6f636b5265776172644c6174656e6379010038543a3a426c6f636b4e756d626572200000000000000000045420426c6f636b20726577617264206c6174656e63792c526577617264506c616e730100ec5665633c526577617264506c616e3c543a3a426c6f636b4e756d6265722c20543a3a4163636f756e7449642c2042616c616e63654f663c543e3e3e040004982053746f7261676520666f7220506f77496e666f20666f722063757272656e7420626c6f636b20546f74616c46656501003042616c616e63654f663c543e400000000000000000000000000000000004a02053746f7261676520666f7220746f74616c2066656520666f722063757272656e7420626c6f636b3843757272656e74506f77496e666f000054506f77496e666f3c543a3a4163636f756e7449643e040004a02053746f7261676520666f7220746f74616c2066656520666f722063757272656e7420626c6f636b0104307365745f706f775f696e666f0410696e666f54506f77496e666f3c543a3a4163636f756e7449643e000104185265776172640484526577617264506c616e3c4e2c204163636f756e7449642c2042616c616e63653e001c696e64696365731c496e646963657301082c4e657874456e756d53657401003c543a3a4163636f756e74496e6465781000000000047c20546865206e657874206672656520656e756d65726174696f6e207365742e1c456e756d5365740101013c543a3a4163636f756e74496e646578445665633c543a3a4163636f756e7449643e00040004582054686520656e756d65726174696f6e20736574732e010001043c4e65774163636f756e74496e64657808244163636f756e744964304163636f756e74496e64657810882041206e6577206163636f756e7420696e646578207761732061737369676e65642e0005012054686973206576656e74206973206e6f7420747269676765726564207768656e20616e206578697374696e6720696e64657820697320726561737369676e65646020746f20616e6f7468657220604163636f756e744964602e2062616c616e6365732042616c616e636573012834546f74616c49737375616e6365010028543a3a42616c616e6365400000000000000000000000000000000004982054686520746f74616c20756e6974732069737375656420696e207468652073797374656d2e484578697374656e7469616c4465706f736974010028543a3a42616c616e6365400000000000000000000000000000000004d420546865206d696e696d756d20616d6f756e7420726571756972656420746f206b65657020616e206163636f756e74206f70656e2e2c5472616e73666572466565010028543a3a42616c616e636540000000000000000000000000000000000494205468652066656520726571756972656420746f206d616b652061207472616e736665722e2c4372656174696f6e466565010028543a3a42616c616e63654000000000000000000000000000000000049c205468652066656520726571756972656420746f2063726561746520616e206163636f756e742e485472616e73616374696f6e42617365466565010028543a3a42616c616e6365400000000000000000000000000000000004dc205468652066656520746f206265207061696420666f72206d616b696e672061207472616e73616374696f6e3b2074686520626173652e485472616e73616374696f6e42797465466565010028543a3a42616c616e63654000000000000000000000000000000000040d01205468652066656520746f206265207061696420666f72206d616b696e672061207472616e73616374696f6e3b20746865207065722d6279746520706f7274696f6e2e1c56657374696e6700010130543a3a4163636f756e7449646c56657374696e675363686564756c653c543a3a42616c616e63653e00040004d820496e666f726d6174696f6e20726567617264696e67207468652076657374696e67206f66206120676976656e206163636f756e742e2c4672656542616c616e636501010130543a3a4163636f756e74496428543a3a42616c616e63650040000000000000000000000000000000002c9c20546865202766726565272062616c616e6365206f66206120676976656e206163636f756e742e004101205468697320697320746865206f6e6c792062616c616e63652074686174206d61747465727320696e207465726d73206f66206d6f7374206f7065726174696f6e73206f6e20746f6b656e732e204974750120616c6f6e65206973207573656420746f2064657465726d696e65207468652062616c616e6365207768656e20696e2074686520636f6e747261637420657865637574696f6e20656e7669726f6e6d656e742e205768656e207468697355012062616c616e63652066616c6c732062656c6f77207468652076616c7565206f6620604578697374656e7469616c4465706f736974602c207468656e20746865202763757272656e74206163636f756e74272069733d012064656c657465643a207370656369666963616c6c7920604672656542616c616e6365602e20467572746865722c2074686520604f6e4672656542616c616e63655a65726f602063616c6c6261636b450120697320696e766f6b65642c20676976696e672061206368616e636520746f2065787465726e616c206d6f64756c657320746f20636c65616e2075702064617461206173736f636961746564207769746854207468652064656c65746564206163636f756e742e005d01206073797374656d3a3a4163636f756e744e6f6e63656020697320616c736f2064656c657465642069662060526573657276656442616c616e63656020697320616c736f207a65726f2028697420616c736f2067657473150120636f6c6c617073656420746f207a65726f2069662069742065766572206265636f6d6573206c657373207468616e20604578697374656e7469616c4465706f736974602e3c526573657276656442616c616e636501010130543a3a4163636f756e74496428543a3a42616c616e63650040000000000000000000000000000000002c75012054686520616d6f756e74206f66207468652062616c616e6365206f66206120676976656e206163636f756e7420746861742069732065787465726e616c6c792072657365727665643b20746869732063616e207374696c6c206765749c20736c61736865642c20627574206765747320736c6173686564206c617374206f6620616c6c2e006d0120546869732062616c616e63652069732061202772657365727665272062616c616e63652074686174206f746865722073756273797374656d732075736520696e206f7264657220746f2073657420617369646520746f6b656e732501207468617420617265207374696c6c20276f776e65642720627920746865206163636f756e7420686f6c6465722c20627574207768696368206172652073757370656e6461626c652e007501205768656e20746869732062616c616e63652066616c6c732062656c6f77207468652076616c7565206f6620604578697374656e7469616c4465706f736974602c207468656e2074686973202772657365727665206163636f756e7427b42069732064656c657465643a207370656369666963616c6c792c2060526573657276656442616c616e6365602e004d01206073797374656d3a3a4163636f756e744e6f6e63656020697320616c736f2064656c6574656420696620604672656542616c616e63656020697320616c736f207a65726f2028697420616c736f2067657473190120636f6c6c617073656420746f207a65726f2069662069742065766572206265636f6d6573206c657373207468616e20604578697374656e7469616c4465706f736974602e29144c6f636b7301010130543a3a4163636f756e744964b05665633c42616c616e63654c6f636b3c543a3a42616c616e63652c20543a3a426c6f636b4e756d6265723e3e00040004b820416e79206c6971756964697479206c6f636b73206f6e20736f6d65206163636f756e742062616c616e6365732e010c207472616e736665720810646573748c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f757263651476616c75654c436f6d706163743c543a3a42616c616e63653e20d8205472616e7366657220736f6d65206c697175696420667265652062616c616e636520746f20616e6f74686572206163636f756e742e00090120607472616e73666572602077696c6c207365742074686520604672656542616c616e636560206f66207468652073656e64657220616e642072656365697665722e21012049742077696c6c2064656372656173652074686520746f74616c2069737375616e6365206f66207468652073797374656d2062792074686520605472616e73666572466565602e1501204966207468652073656e6465722773206163636f756e742069732062656c6f7720746865206578697374656e7469616c206465706f736974206173206120726573756c74b4206f6620746865207472616e736665722c20746865206163636f756e742077696c6c206265207265617065642e00190120546865206469737061746368206f726967696e20666f7220746869732063616c6c206d75737420626520605369676e65646020627920746865207472616e736163746f722e2c7365745f62616c616e63650c0c77686f8c3c543a3a4c6f6f6b7570206173205374617469634c6f6f6b75703e3a3a536f7572636510667265654c436f6d706163743c543a3a42616c616e63653e2072657365727665644c436f6d706163743c543a3a42616c616e63653e209420536574207468652062616c616e636573206f66206120676976656e206163636f756e742e00010120546869732077696c6c20616c74657220604672656542616c616e63656020616e642060526573657276656442616c616e63656020696e2073746f726167652e190120496620746865206e65772066726565206f722072657365727665642062616c616e63652069732062656c6f7720746865206578697374656e7469616c206465706f7369742c25012069742077696c6c20616c736f2064656372656173652074686520746f74616c2069737375616e6365206f66207468652073797374656d202860546f74616c49737375616e63656029d820616e6420726573657420746865206163636f756e74206e6f6e636520286073797374656d3a3a4163636f756e744e6f6e636560292e00b420546865206469737061746368206f726967696e20666f7220746869732063616c6c2069732060726f6f74602e3872656c61795f7472616e7366657210207472616e736665721c5665633c75383e1868656967687430436f6d706163743c7536343e10686173681c543a3a4861736818706172656e741c543a3a486173680c7020657865637574652072656c6179207472616e7366657220706172740000010c284e65774163636f756e7408244163636f756e7449641c42616c616e6365046c2041206e6577206163636f756e742077617320637265617465642e345265617065644163636f756e7404244163636f756e744964045c20416e206163636f756e7420776173207265617065642e205472616e7366657210244163636f756e744964244163636f756e7449641c42616c616e63651c42616c616e636504b0205472616e7366657220737563636565646564202866726f6d2c20746f2c2076616c75652c2066656573292e207368617264696e67205368617264696e6701105047656e657369735368617264696e67436f756e7401002c543a3a53686172644e756d08000004ac20546f74616c207368617264696e6720636f756e74207573656420696e2067656e6573697320626c6f636b545363616c654f75744f627365727665426c6f636b73010038543a3a426c6f636b4e756d62657220000000000000000004ac20546f74616c207368617264696e6720636f756e74207573656420696e2067656e6573697320626c6f636b4043757272656e745368617264496e666f0000585368617264496e666f3c543a3a53686172644e756d3e040004b42053746f7261676520666f72205368617264496e666f207573656420666f722063757272656e7420626c6f636b5043757272656e745363616c654f757450686173650000a85363616c654f757450686173653c543a3a426c6f636b4e756d6265722c20543a3a53686172644e756d3e040004c42053746f7261676520666f72205363616c654f75745068617365207573656420666f722063757272656e7420626c6f636b0104387365745f73686172645f696e666f0410696e666f585368617264496e666f3c543a3a53686172644e756d3e00001063726667304372666746696e616c69747901043450656e64696e674368616e67650000c853746f72656450656e64696e674368616e67653c543a3a426c6f636b4e756d6265722c20543a3a53657373696f6e4b65793e0400000104487570646174655f617574686f7269746965730410696e666f603c542061732054726169743e3a3a53657373696f6e4b6579000104384e6577417574686f72697469657304585665633c2853657373696f6e4b65792c20753634293e0490204e657720617574686f726974792073657420686173206265656e206170706c6965642e4066696e616c6974795f747261636b6572000001044c77726974655f66696e616c697a65645f6c6f67041068696e742c543a3a46696e616c4e756d08f42048696e7420746861742074686520617574686f72206f66207468697320626c6f636b207468696e6b732074686520626573742066696e616c697a65646c20626c6f636b2069732074686520676976656e206e756d6265722e00"
        metadata_decoder = MetadataDecoder(ScaleBytes(metadata_vx))
        metadata_decoder.decode()

        events_decoder = EventsDecoder(
            data=ScaleBytes(
                '0x1c00000000000000000100000000000002000000000000030000000000000400000000000101001f6e000000000000a0837b84eedaf81b26323f05426b39eeedbb4d28868727de045eb679ac2c9b59807c814a0000000000000000000000000000000000000000000000000000000001040018dc4fbd189c6c26f0d0f052022f8a471e546ca7e2aa6b2bface2ce22e5f03c2d50100000000000000dc4fbd189c6c26f0d0f052022f8a471e546ca7e2aa6b2bface2ce22e5f03c2d50100000000000000dc4fbd189c6c26f0d0f052022f8a471e546ca7e2aa6b2bface2ce22e5f03c2d50100000000000000dc4fbd189c6c26f0d0f052022f8a471e546ca7e2aa6b2bface2ce22e5f03c2d50100000000000000dc4fbd189c6c26f0d0f052022f8a471e546ca7e2aa6b2bface2ce22e5f03c2d50100000000000000dc4fbd189c6c26f0d0f052022f8a471e546ca7e2aa6b2bface2ce22e5f03c2d50100000000000000'),
            metadata=metadata_decoder
        )
        events_decoder.decode()

        print(events_decoder)

    def test_balance(self):
        obj = ScaleDecoder.get_decoder_class('Compact<Balance>', ScaleBytes("0x130080cd103d71bc22"))
        obj.decode()
        self.assertEqual(obj.value, 2503000000000000000)

    def test_unknown_decoder_class(self):
        self.assertRaises(NotImplementedError, ScaleDecoder.get_decoder_class, 'UnknownType123', ScaleBytes("0x0c00"))

    # TODO make type_index in Metadatadecoder and add tests if all types are supported

    def test_originhash(self):
        a = '290281ff927b69286c0137e2ff66c6e561f721d2e6a2e9b92402d2eed7aebdca99005c705efcd6ebd1991697769d82513325a49276b6044142054fa9617a015b3c5af102ccfbce2b75c1e6627b743b3ff35933b926532d51f3287bbc180072d50f71bd0b1c65020400ffaa5f074351d8eadc796e3e25303db8813517f67294740d44d55e2dd63de61b5e516b'
        b = blake2b(bytearray.fromhex(a), digest_size=32).digest().hex()
        print(b)

    def test_log(self):
        # logs in header
        # "logs": [
        #     "0x00 18 02 00 00 00 04 00", //6字节
        #      0x00 18 02 00 01 00 04 00
        #      0x00 18 02 00 02 00 04 00
        #     "0x00 ed 03030000000000000000001850907ff82b2d1fb8d7d07fe9cc0c6e33454e1e98abce6714d20567fbf33be078010000000000000050907ff82b2d1fb8d7d07fe9cc0c6e33454e1e98abce6714d20567fbf33be078010000000000000050907ff82b2d1fb8d7d07fe9cc0c6e33454e1e98abce6714d20567fbf33be078010000000000000050907ff82b2d1fb8d7d07fe9cc0c6e33454e1e98abce6714d20567fbf33be078010000000000000050907ff82b2d1fb8d7d07fe9cc0c6e33454e1e98abce6714d20567fbf33be078010000000000000050907ff82b2d1fb8d7d07fe9cc0c6e33454e1e98abce6714d20567fbf33be0780100000000000000",
        #     "0x00 28 04008a0b000000000000",
        #     "0x0459656521750350907ff82b2d1fb8d7d07fe9cc0c6e33454e1e98abce6714d20567fbf33be078dee67cd3e950d9ecc58898fd0f94e94865f7e226e66e66b43683ed870c0100004e2989c06e01000002287965652d7377697463689f3314763de4e45e5c609767a4f860515a29503f50096bfa7ee3d81d769be64f2b15000000000000085afb1172f6a2a4611043764a56a6ce759f30fefb156293b4e26ba1a42b4f8ce278c86f19241fe16267983b35b4994d824acf5f8884aa98dabfbaed6ae41d28e185c09af929492a871e4fae32d9d5c36e352471cd659bcdb61de08f1722acc3b1"
        # ]

        input = '0x0459656521750350907ff82b2d1fb8d7d07fe9cc0c6e33454e1e98abce6714d20567fbf33be078dee67cd3e950d9ecc58898fd0f94e94865f7e226e66e66b43683ed870c0100004e2989c06e01000002287965652d7377697463689f3314763de4e45e5c609767a4f860515a29503f50096bfa7ee3d81d769be64f2b15000000000000085afb1172f6a2a4611043764a56a6ce759f30fefb156293b4e26ba1a42b4f8ce278c86f19241fe16267983b35b4994d824acf5f8884aa98dabfbaed6ae41d28e185c09af929492a871e4fae32d9d5c36e352471cd659bcdb61de08f1722acc3b1'
        log = bytearray.fromhex(input[2:])

        digestItemType = log[0:1]
        print(digestItemType.hex())

        data = input[10:20]
        print(data)  # 7503c93b27

        c = CompactU32(ScaleBytes(bytearray.fromhex(data)))

        obj = ScaleDecoder.get_decoder_class('Compact<u32>', ScaleBytes(bytearray.fromhex(data)))
        obj.decode()
        print(obj.value)
        veclen = c.process()
        print(veclen)
        compactLen = None
        if veclen <= 0b00111111:
            compactLen = 1
        elif veclen <= 0b0011111111111111:
            compactLen = 2

        elif veclen <= 0b00111111111111111111111111111111:
            compactLen = 4
        else:
            compactLen = 5
        print(compactLen)

        len = 2 + 8 + compactLen * 2 + 64 + 64 + 16
        print(len)

        # workProofType = U16(bytearray.fromhex())
        # workProofType.process()

        print(input[len:len + 2])

        workProofType = ScaleDecoder.get_decoder_class('U16', ScaleBytes('0x' + str(input[len:len + 2])))
        workProofType.decode()
        print(workProofType.value)

        workProofOffset = 2 + 8 + compactLen * 2 + 64 + 64 + 16 + 2
        print(workProofOffset)

        if workProofType.value == 2:
            dataforextraDataLen = input[workProofOffset:(workProofOffset + 170)]

            extraDataLen = ScaleDecoder.get_decoder_class('Compact<u32>',
                                                          ScaleBytes(bytearray.fromhex(dataforextraDataLen)))
            extraDataLen.decode()
            print(extraDataLen.value)

            if extraDataLen.value <= 0b00111111:
                compactLen = 1
            elif extraDataLen <= 0b0011111111111111:
                compactLen = 2

            elif extraDataLen.value <= 0b00111111111111111111111111111111:
                compactLen = 4
            else:
                compactLen = 5
            print(compactLen)
            print("--------------")
            mlen = workProofOffset + compactLen * 2 + extraDataLen.value * 2
            print(mlen)
            merkleRoot = input[mlen:mlen + 64]
            print(merkleRoot)

    def test_log1(self):

        # m = ScaleDecoder.get_decoder_class('Compact<u32>', ScaleBytes('0x18'))
        # m.decode()
        # print(m.value)
        log_shard = '0x0018020003000400'
        if log_shard[0:10] == '0x00180200':
            shard = '0x' + log_shard[10:18]
           # print(shard)
            x = ScaleDecoder.get_decoder_class('ShardInfo<ShardNum>', ScaleBytes(shard))
            x.decode()
            print(x.value)
            print('------------')

        log_Finalitytrack = '0x002804006983000000000000'
        if log_Finalitytrack[0:10] == '0x00280400':
            obj = ScaleDecoder.get_decoder_class('U64', ScaleBytes("0x6983000000000000"))
            obj.decode()
            print(obj.value)
            print('------------')
        # 0x00 --other
        # ed03 --Compact 251
        # 03   --crfg
        # 00   --enum AuthoritiesChangeSignal
        # 00 00 00 00 00 00 00 00  	AuthoritiesChangeSignal(N, Vec<(SessionKey, u64)>) 的N（延迟区块高度）
        # 18 -- Vec < (SessionKey, u64) > 有6个此类型的元组
        log_Finalitytrack = '0x00ed030300000000000000000018c93b279b1bff3ab37ba8a10029e2073b898bc87b66f826c13dfc19973f13ae130100000000000000c93b279b1bff3ab37ba8a10029e2073b898bc87b66f826c13dfc19973f13ae130100000000000000c93b279b1bff3ab37ba8a10029e2073b898bc87b66f826c13dfc19973f13ae130100000000000000c93b279b1bff3ab37ba8a10029e2073b898bc87b66f826c13dfc19973f13ae130100000000000000c93b279b1bff3ab37ba8a10029e2073b898bc87b66f826c13dfc19973f13ae130100000000000000c93b279b1bff3ab37ba8a10029e2073b898bc87b66f826c13dfc19973f13ae130100000000000000'
        if log_Finalitytrack[0:12] == '0x00ed030300':
            final = '0x' + log_Finalitytrack[28:]
            #print(final)
            oy = ScaleDecoder.get_decoder_class('Vec<(SessionKey, u64)>', ScaleBytes(final))
            oy.decode()
            print(oy.value)

        # ox = ScaleDecoder.get_decoder_class('U64', ScaleBytes("0x0100000000000000"))
        # ox.decode()
        # print(ox.value)
    def test_log2(self):
        log_digest = LogDigest(ScaleBytes('0x04596565217503c93b279b1bff3ab37ba8a10029e2073b898bc87b66f826c13dfc19973f13ae1374dbe4e0a76174a060f413b2b41faef181643f5d87aca28203b253dec8160000ee1fcc126f01000002287965652d7377697463689f12aa2df04117d314930f7c9cf85607fce5b748de74476d1720ec708e52eb89019c050000000000083edced7e119521739ada9d663fbf44a99265977fd0152f1fbfbfd40836c930e70b7cdda44d2c7e6d1b116c9878daf25ab02fecb5cc84468cb38d0a8ac03dad1885c09af929492a871e4fae32d9d5c36e352471cd659bcdb61de08f1722acc3b1'))
        log_digest.decode()
        print(log_digest.value)

